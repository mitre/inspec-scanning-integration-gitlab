.ci:stage:kitchen-exec:inspec:
  image:
    name: $REGISTRY/$INSPEC_RUNNER_IMAGE_ID:$INSPEC_RUNNER_IMAGE_TAG
    entrypoint: [""]
  variables:
    CHEF_LICENSE: 'accept-silent'
  stage: validate
  before_script:
    - export CI_JOB_TIMESTAMP=$(date --utc --iso-8601=seconds)
  script:

    # Echoing out the Inspec version for this run.
    - echo "Using Inspec Version - $(inspec version)"
    
    # Does the profile have gem dependencies? If so, use bundle to make sure they
    # are respected
    - if [ -f "./Gemfile" ]; then

        bundle install;

        if [ "$DEBUG" = 'true' ]; then
          bundle exec kitchen list || true;
          bundle exec kitchen create || true;
          bundle exec kitchen converge || true;
          bundle exec kitchen verify || true;
          bundle exec kitchen destroy || true;
        else
          bundle exec kitchen test --destroy=always || true;
        fi
      else
        if [ "$DEBUG" = 'true' ]; then
          kitchen list || true;
          kitchen create || true;
          kitchen converge || true;
          kitchen verify || true;
          kitchen destroy || true;
        else
          kitchen test --destroy=always || true;
        fi
      fi

  allow_failure: false
  tags:
  - sandbox
  artifacts:
    name: "$CI_JOB_NAME"
    when: always
    expire_in: 1 month
    paths:
    - $CI_PROJECT_DIR/reports/raw/*.json
