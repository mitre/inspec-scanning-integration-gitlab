
.ci:stage:saf:verify:
  image:
    name: mitre/saf
    entrypoint: [""]
  stage: verify
  script:
      - echo "Running summary reports"
      - echo "Vanilla"
      - saf view:summary -i $CI_PROJECT_DIR/reports/raw/ubi-vanilla*.json -j -o $CI_PROJECT_DIR/reports/summary/$CI_PIPELINE_ID-ubi-vanilla-summary.json;

      - echo "Hardened"
      - saf view:summary -i $CI_PROJECT_DIR/reports/raw/ubi-hardened*.json -j -o $CI_PROJECT_DIR/reports/summary/$CI_PIPELINE_ID-ubi-hardened-summary.json;

      - echo "Verifying thresholds were met"
      - saf validate:threshold -i $CI_PROJECT_DIR/reports/raw/ubi-vanilla*.json -F ./vanilla.threshold.yml;
      - saf validate:threshold -i $CI_PROJECT_DIR/reports/raw/ubi-hardened*.json -F ./hardened.threshold.yml;

  artifacts:
    name: "$CI_JOB_NAME"
    when: always
    expire_in: 1 month
    paths:
    - $CI_PROJECT_DIR/reports/summary/*.json
